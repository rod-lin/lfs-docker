# lfs-docker

Build Linux From Scratch using Docker.
Based on [LFS 11.1-systemd](https://www.linuxfromscratch.org/lfs/view/11.1-systemd).

## Usage

First, [install Docker](https://docs.docker.com/get-docker/) on your system.
A Docker version >= 18.09 is required since some BuildKit features are used in the Dockerfile.

Now `cd` into this repo, and then simply run
```
DOCKER_BUILDKIT=1 docker build -o . .
```
If the build succeeds, an ISO image `lfs.iso` will be produced in the current directory

On a laptop with a 4-core (8-thread) low-power Intel CPU and 16 GB of memory,
the entire build took roughly 2 hours and used about 15 GB of disk space.

## How does the Dockerfile work

This Dockerfile is self-contained and does not use any files from the context
(except for source files that need to be downloaded, which are also specified in the Dockerfile).

One crucial feature used in this Dockerfile is the [multi-stage build](https://docs.docker.com/develop/develop-images/multistage-build/), which essentially allows one
to sequentially specify multiple images in a Dockerfile, and each image can reference files
from previous images.

Using multi-stage build, our Dockerfile is splitted into the following stages,
each corresponding to a different part of the LFS manual:
```
# Stage 1: preparing the host
# Sections 2 - 7.3 are done in this stage
FROM alpine AS host
...

# Stage 2: chroot into the toolchain and build from there
# Sections 7.4 - 7.14 are done in this stage
FROM scratch AS toolchain
COPY --from=host ${LFS} /
...

# Stage 3: building the packages in the final system
# Sections 8 - 10 are done in this stage
FROM toolchain AS system
...

# Stage 4: build an ISO image
FROM alpine:3.16 AS iso-builder
...
```

Notably, the stage 2 delegates the job of chroot (used in LFS manual section 7.4) to Docker,
so we do not need any `--privileged` flag to perform this action.

## More details on making a bootable ISO image

For booting the ISO image, I decided to use GRUB 2 with the
goal to support booting with both legacy BIOS and UEFI.

This requires GRUB 2.06 to be compiled with support for both `i386-pc` and `x86_64-efi` targets.

The final directory structure of the ISO image looks like this:
```
boot/
  - grub/
      - i386-pc/
          - eltorito.img # for BIOS booting
      - x86_64-efi/
          - efi.img      # for UEFI booting
      - grub.cfg         # GRUB configuration
  - vmlinuz              # Linux kernel
  - initramfs.cpio.gz    # initramfs
system.squashfs          # The actual LFS system packaged using squashfs
```

`eltorito.img` is the concatenation of `/usr/lib/grub/i386-pc/cdboot.img` and an image generated by `grub-mkimage`.

`efi.img` is an image formatted with FAT, and it used as the EFI System Partition (ESP).
When mounted, `efi.img` should contain a single file `/efi/boot/bootx64.efi`,
which is also generated by `grub-mkimage`.
See the Dockerfile for more details on how `grub-mkimage` is called.

When booted with BIOS, the machine will load `eltorito.img`,
which will run GRUB with the configuration file `grub.cfg`.

When booted with UEFI, the image `efi.img` will be loaded instead, and `/efi/boot/bootx64.efi`
within the image will be executed with a preloaded GRUB configuration (see `resources/grub-stub.cfg`).
This preloaded configuration will then search for the actual boot drive and use `grub.cfg` from there.

There is also some black magic to allow booting from, say, a USB flash drive, when the ISO image is written to it (e.g. `dd if=lfs.iso of=<USB drive>`).

Some useful resources:
- UEFI support in kernel: https://www.linuxfromscratch.org/blfs/view/11.1-systemd/postlfs/grub-setup.html#uefi-kernel
- Making initramfs: https://lyngvaer.no/log/create-linux-initramfs
- Making a UEFI bootable ISO image using GRUB: https://github.com/syzdek/efibootiso
- Making a UEFI + BIOS bootable ISO image using GRUB: https://opendev.org/airship/images/src/commit/5e55597fbcebc9e16006e06b7514b21b9882dc8d/debian-isogen/files/functions.sh
- GRUB modules: https://www.linux.org/threads/understanding-the-various-grub-modules.11142/
- Syslinux/isolinux usage: https://wiki.syslinux.org/wiki/index.php?title=ISOLINUX
- Making a "hybrid" image for syslinux: https://wiki.syslinux.org/wiki/index.php?title=Isohybrid#UEFI

## Related work

- https://github.com/reinterpretcat/lfs
- https://github.com/0rland/lfs-docker
- https://github.com/pbret/lfs-docker
- https://github.com/EvilFreelancer/docker-lfs-build
